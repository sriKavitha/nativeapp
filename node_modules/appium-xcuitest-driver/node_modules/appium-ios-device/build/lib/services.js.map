{"version":3,"file":"services.js","names":["_utilities","require","_syslog","_simulatelocation","_webinspector","_installationProxy","_afc","_notificationProxy","_houseArrest","_instrument","_testmanagerd","_mcinstall","_plistService","_interopRequireDefault","_semver","CRASH_LOG_SERVICE_NAME","INSTRUMENT_HANDSHAKE_VERSION","TESTMANAGERD_HANDSHAKE_VERSION","startSyslogService","udid","opts","socket","startService","SYSLOG_SERVICE_NAME","SyslogService","startSimulateLocationService","SIMULATE_LOCATION_SERVICE_NAME","SimulateLocationService","startWebInspectorService","osVersion","getOSVersion","isSimulator","verbose","verboseHexDump","socketChunkSize","maxFrameLength","semverVersion","semver","coerce","Error","WebInspectorService","majorOsVersion","major","socketClient","WEB_INSPECTOR_SERVICE_NAME","undefined","startInstallationProxyService","INSTALLATION_PROXY_SERVICE_NAME","InstallationProxyService","PlistService","startAfcService","AFC_SERVICE_NAME","AfcService","startCrashLogService","startNotificationProxyService","NOTIFICATION_PROXY_SERVICE_NAME","NotificationProxyService","startHouseArrestService","HOUSE_ARREST_SERVICE_NAME","HouseArrestService","startInstrumentService","InstrumentService","parseInt","split","INSTRUMENT_SERVICE_NAME","INSTRUMENT_SERVICE_NAME_VERSION_14","startTestmanagerdService","TestmanagerdService","TESTMANAGERD_SERVICE_NAME","TESTMANAGERD_SERVICE_NAME_VERSION_14","startMCInstallService","MC_INSTALL_SERVICE_NAME","MCInstallProxyService","serviceName","handshakeOnly","lockdown","startLockdownSession","service","EnableServiceSSL","connectPortSSL","Port","connectPort","close"],"sources":["../../lib/services.js"],"sourcesContent":["import { connectPort, connectPortSSL, startLockdownSession, getOSVersion } from './utilities';\nimport { SyslogService, SYSLOG_SERVICE_NAME } from './syslog';\nimport { SimulateLocationService, SIMULATE_LOCATION_SERVICE_NAME } from './simulatelocation';\nimport { WebInspectorService, WEB_INSPECTOR_SERVICE_NAME } from './webinspector';\nimport { InstallationProxyService, INSTALLATION_PROXY_SERVICE_NAME } from './installation-proxy';\nimport { AfcService, AFC_SERVICE_NAME } from './afc';\nimport { NotificationProxyService, NOTIFICATION_PROXY_SERVICE_NAME } from './notification-proxy';\nimport { HouseArrestService, HOUSE_ARREST_SERVICE_NAME } from './house-arrest';\nimport { InstrumentService, INSTRUMENT_SERVICE_NAME_VERSION_14, INSTRUMENT_SERVICE_NAME} from './instrument';\nimport { TestmanagerdService, TESTMANAGERD_SERVICE_NAME_VERSION_14, TESTMANAGERD_SERVICE_NAME } from './testmanagerd';\nimport { MCInstallProxyService, MC_INSTALL_SERVICE_NAME} from './mcinstall';\nimport PlistService from './plist-service';\nimport semver from 'semver';\n\nconst CRASH_LOG_SERVICE_NAME = 'com.apple.crashreportcopymobile';\nconst INSTRUMENT_HANDSHAKE_VERSION = 14;\nconst TESTMANAGERD_HANDSHAKE_VERSION = 14;\n\nasync function startSyslogService (udid, opts = {}) {\n  const socket = await startService(udid, SYSLOG_SERVICE_NAME, opts.socket);\n  return new SyslogService(socket);\n}\n\nasync function startSimulateLocationService (udid, opts = {}) {\n  const socket = await startService(udid, SIMULATE_LOCATION_SERVICE_NAME, opts.socket);\n  return new SimulateLocationService(socket);\n}\n\nasync function startWebInspectorService (udid, opts = {}) {\n  const osVersion = opts.osVersion || await getOSVersion(udid, opts.socket);\n  const isSimulator = !!opts.isSimulator;\n  const verbose = !!opts.verbose;\n  const verboseHexDump = !!opts.verboseHexDump;\n  const socketChunkSize = opts.socketChunkSize;\n  const maxFrameLength = opts.maxFrameLength;\n  const semverVersion = semver.coerce(osVersion);\n  if (!semverVersion) {\n    throw new Error(`Could not create a semver version out of '${osVersion}'`);\n  }\n  if (opts.socket) {\n    return new WebInspectorService({\n      majorOsVersion: semverVersion.major,\n      isSimulator,\n      socketChunkSize,\n      verbose,\n      verboseHexDump,\n      socketClient: opts.socket,\n      maxFrameLength,\n    });\n  }\n  const socket = await startService(udid, WEB_INSPECTOR_SERVICE_NAME, undefined);\n  return new WebInspectorService({\n    majorOsVersion: semverVersion.major,\n    isSimulator,\n    socketChunkSize,\n    verbose,\n    verboseHexDump,\n    socketClient: socket,\n    maxFrameLength,\n  });\n}\n\nasync function startInstallationProxyService (udid, opts = {}) {\n  const socket = await startService(udid, INSTALLATION_PROXY_SERVICE_NAME, opts.socket);\n  return new InstallationProxyService(new PlistService(socket));\n}\n\nasync function startAfcService (udid, opts = {}) {\n  const socket = await startService(udid, AFC_SERVICE_NAME, opts.socket);\n  return new AfcService(socket);\n}\n\nasync function startCrashLogService (udid, opts = {}) {\n  const socket = await startService(udid, CRASH_LOG_SERVICE_NAME, opts.socket);\n  return new AfcService(socket);\n}\n\nasync function startNotificationProxyService (udid, opts = {}) {\n  const socket = await startService(udid, NOTIFICATION_PROXY_SERVICE_NAME, opts.socket);\n  return new NotificationProxyService(socket);\n}\n\nasync function startHouseArrestService (udid, opts = {}) {\n  const socket = await startService(udid, HOUSE_ARREST_SERVICE_NAME, opts.socket);\n  return new HouseArrestService(socket);\n}\n\nasync function startInstrumentService (udid, opts = {}) {\n  const osVersion = opts.osVersion || await getOSVersion(udid, opts.socket);\n  return new InstrumentService(\n  parseInt(osVersion.split('.')[0], 10) < INSTRUMENT_HANDSHAKE_VERSION\n    ? await startService(udid, INSTRUMENT_SERVICE_NAME, opts.socket, true)\n    : await startService(udid, INSTRUMENT_SERVICE_NAME_VERSION_14, opts.socket)\n  );\n}\n\nasync function startTestmanagerdService (udid, opts = {}) {\n  const osVersion = opts.osVersion || await getOSVersion(udid, opts.socket);\n  return new TestmanagerdService(\n    parseInt(osVersion.split('.')[0], 10) < TESTMANAGERD_HANDSHAKE_VERSION\n      ? await startService(udid, TESTMANAGERD_SERVICE_NAME, opts.socket, true)\n      : await startService(udid, TESTMANAGERD_SERVICE_NAME_VERSION_14, opts.socket)\n  );\n}\n\nasync function startMCInstallService (udid, opts = {}) {\n  const socket = await startService(udid, MC_INSTALL_SERVICE_NAME, opts.socket);\n  return new MCInstallProxyService(new PlistService(socket));\n}\n\nasync function startService (udid, serviceName, socket, handshakeOnly = false) {\n  const lockdown = await startLockdownSession(udid, socket);\n  try {\n    const service = await lockdown.startService(serviceName);\n    if (service.EnableServiceSSL) {\n      return await connectPortSSL(udid, service.Port, socket, handshakeOnly);\n    } else {\n      return await connectPort(udid, service.Port, socket);\n    }\n  } finally {\n    lockdown.close();\n  }\n}\n\nexport {\n  startSyslogService, startWebInspectorService,\n  startInstallationProxyService, startSimulateLocationService,\n  startAfcService, startCrashLogService, startNotificationProxyService,\n  startHouseArrestService, startInstrumentService, startTestmanagerdService,\n  startMCInstallService\n};\n"],"mappings":"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"}