"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Usbmux = void 0;
exports.getDefaultSocket = getDefaultSocket;
require("source-map-support/register");
var _net = _interopRequireDefault(require("net"));
var _os = _interopRequireDefault(require("os"));
var _lodash = _interopRequireDefault(require("lodash"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _support = require("@appium/support");
var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));
var _usbmuxDecoder = _interopRequireDefault(require("./transformer/usbmux-decoder.js"));
var _usbmuxEncoder = _interopRequireDefault(require("./transformer/usbmux-encoder.js"));
var _path = _interopRequireDefault(require("path"));
var _plistService = _interopRequireDefault(require("../plist-service"));
var _lockdown = require("../lockdown");
var _baseService = require("../base-service");
var _constants = require("../constants");
const MAX_FRAME_SIZE = 1 * _constants.MB;
const USBMUX_RESULT = {
  OK: 0,
  BADCOMMAND: 1,
  BADDEV: 2,
  CONNREFUSED: 3
};
let name, version;
try {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', '..', 'package.json')));
} catch (err) {
  ({
    name,
    version
  } = require(_path.default.resolve(__dirname, '..', '..', 'package.json')));
}
const DEFAULT_USBMUXD_SOCKET = '/var/run/usbmuxd';
const DEFAULT_USBMUXD_PORT = 27015;
const DEFAULT_USBMUXD_HOST = '127.0.0.1';
const PROG_NAME = name;
const CLIENT_VERSION_STRING = `${name}-${version}`;
function swap16(val) {
  return (val & 0xFF) << 8 | val >> 8 & 0xFF;
}
async function getDefaultSocket(opts = {}) {
  const {
    socketPath = DEFAULT_USBMUXD_SOCKET,
    socketPort = DEFAULT_USBMUXD_PORT,
    socketHost = DEFAULT_USBMUXD_HOST,
    timeout = 5000
  } = opts;
  let socket;
  if (await _support.fs.exists(socketPath)) {
    socket = _net.default.createConnection(socketPath);
  } else if (process.platform === 'win32' || process.platform === 'linux' && /microsoft/i.test(_os.default.release())) {
    socket = _net.default.createConnection(socketPort, socketHost);
  } else {
    throw new Error(`The usbmuxd socket at '${socketPath}' does not exist or is not accessible`);
  }
  return await new _bluebird.default((resolve, reject) => {
    socket.once('error', reject);
    socket.once('connect', () => resolve(socket));
  }).timeout(timeout);
}
class Usbmux extends _baseService.BaseServiceSocket {
  constructor(socketClient) {
    super(socketClient);
    this._decoder = new _usbmuxDecoder.default();
    this._splitter = new _lengthBasedSplitter.default({
      readableStream: socketClient,
      littleEndian: true,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 0
    });
    this._socketClient.pipe(this._splitter).pipe(this._decoder);
    this._encoder = new _usbmuxEncoder.default();
    this._encoder.pipe(this._socketClient);
    this._assignClientFailureHandlers(this._encoder);
    this._tag = 0;
    this._responseCallbacks = {};
    this._decoder.on('data', this._handleData.bind(this));
  }
  _handleData(data) {
    const cb = this._responseCallbacks[data.header.tag] || _lodash.default.noop;
    cb(data);
  }
  async readBUID(timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.BUID) {
        return data.payload.BUID;
      }
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ReadBUID',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });
    return await receivePromise;
  }
  async readPairRecord(udid, timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (!data.payload.PairRecordData) {
        return null;
      }
      try {
        return _support.plist.parsePlist(data.payload.PairRecordData);
      } catch (err) {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ReadPairRecord',
        PairRecordID: udid,
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });
    return await receivePromise;
  }
  _sendPlist(json) {
    this._encoder.write(json);
  }
  _receivePlistPromise(timeout = 5000, responseCallback) {
    const tag = this._tag++;
    const receivePromise = new _bluebird.default((resolve, reject) => {
      this._responseCallbacks[tag] = data => {
        try {
          resolve(responseCallback(data));
        } catch (e) {
          reject(e);
        }
      };
      setTimeout(() => reject(new Error(`Failed to receive any data within the timeout: ${timeout}`)), timeout);
    });
    return {
      tag,
      receivePromise
    };
  }
  async listDevices(timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.DeviceList) {
        return data.payload.DeviceList;
      }
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'ListDevices',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING
      }
    });
    return await receivePromise;
  }
  async findDevice(udid, timeout = 5000) {
    const devices = await this.listDevices(timeout);
    return _lodash.default.find(devices, device => device.Properties.SerialNumber === udid);
  }
  async connectLockdown(udid, timeout = 5000) {
    const device = await this.findDevice(udid, timeout);
    if (!device) {
      throw new Error(`Could not find the expected device '${udid}'`);
    }
    const socket = await this.connect(device.Properties.DeviceID, _lockdown.LOCKDOWN_PORT, timeout);
    return new _lockdown.Lockdown(new _plistService.default(socket));
  }
  async connect(deviceID, port, timeout = 5000) {
    const {
      tag,
      receivePromise
    } = this._receivePlistPromise(timeout, data => {
      if (data.payload.MessageType !== 'Result') {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
      if (data.payload.Number === USBMUX_RESULT.OK) {
        this._splitter.shutdown();
        this._socketClient.unpipe(this._splitter);
        this._splitter.unpipe(this._decoder);
        return this._socketClient;
      } else if (data.payload.Number === USBMUX_RESULT.CONNREFUSED) {
        throw new Error(`Connection was refused to port ${port}`);
      } else {
        throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
      }
    });
    this._sendPlist({
      tag,
      payload: {
        MessageType: 'Connect',
        ProgName: PROG_NAME,
        ClientVersionString: CLIENT_VERSION_STRING,
        DeviceID: deviceID,
        PortNumber: swap16(port)
      }
    });
    return await receivePromise;
  }
}
exports.Usbmux = Usbmux;
var _default = Usbmux;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbmV0IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfb3MiLCJfbG9kYXNoIiwiX2JsdWViaXJkIiwiX3N1cHBvcnQiLCJfbGVuZ3RoQmFzZWRTcGxpdHRlciIsIl91c2JtdXhEZWNvZGVyIiwiX3VzYm11eEVuY29kZXIiLCJfcGF0aCIsIl9wbGlzdFNlcnZpY2UiLCJfbG9ja2Rvd24iLCJfYmFzZVNlcnZpY2UiLCJfY29uc3RhbnRzIiwiTUFYX0ZSQU1FX1NJWkUiLCJNQiIsIlVTQk1VWF9SRVNVTFQiLCJPSyIsIkJBRENPTU1BTkQiLCJCQURERVYiLCJDT05OUkVGVVNFRCIsIm5hbWUiLCJ2ZXJzaW9uIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJlcnIiLCJERUZBVUxUX1VTQk1VWERfU09DS0VUIiwiREVGQVVMVF9VU0JNVVhEX1BPUlQiLCJERUZBVUxUX1VTQk1VWERfSE9TVCIsIlBST0dfTkFNRSIsIkNMSUVOVF9WRVJTSU9OX1NUUklORyIsInN3YXAxNiIsInZhbCIsImdldERlZmF1bHRTb2NrZXQiLCJvcHRzIiwic29ja2V0UGF0aCIsInNvY2tldFBvcnQiLCJzb2NrZXRIb3N0IiwidGltZW91dCIsInNvY2tldCIsImZzIiwiZXhpc3RzIiwibmV0IiwiY3JlYXRlQ29ubmVjdGlvbiIsInByb2Nlc3MiLCJwbGF0Zm9ybSIsInRlc3QiLCJvcyIsInJlbGVhc2UiLCJFcnJvciIsIkIiLCJyZWplY3QiLCJvbmNlIiwiVXNibXV4IiwiQmFzZVNlcnZpY2VTb2NrZXQiLCJjb25zdHJ1Y3RvciIsInNvY2tldENsaWVudCIsIl9kZWNvZGVyIiwiVXNibXV4RGVjb2RlciIsIl9zcGxpdHRlciIsIkxlbmd0aEJhc2VkU3BsaXR0ZXIiLCJyZWFkYWJsZVN0cmVhbSIsImxpdHRsZUVuZGlhbiIsIm1heEZyYW1lTGVuZ3RoIiwibGVuZ3RoRmllbGRPZmZzZXQiLCJsZW5ndGhGaWVsZExlbmd0aCIsImxlbmd0aEFkanVzdG1lbnQiLCJfc29ja2V0Q2xpZW50IiwicGlwZSIsIl9lbmNvZGVyIiwiVXNibXV4RW5jb2RlciIsIl9hc3NpZ25DbGllbnRGYWlsdXJlSGFuZGxlcnMiLCJfdGFnIiwiX3Jlc3BvbnNlQ2FsbGJhY2tzIiwib24iLCJfaGFuZGxlRGF0YSIsImJpbmQiLCJkYXRhIiwiY2IiLCJoZWFkZXIiLCJ0YWciLCJfIiwibm9vcCIsInJlYWRCVUlEIiwicmVjZWl2ZVByb21pc2UiLCJfcmVjZWl2ZVBsaXN0UHJvbWlzZSIsInBheWxvYWQiLCJCVUlEIiwiSlNPTiIsInN0cmluZ2lmeSIsIl9zZW5kUGxpc3QiLCJNZXNzYWdlVHlwZSIsIlByb2dOYW1lIiwiQ2xpZW50VmVyc2lvblN0cmluZyIsInJlYWRQYWlyUmVjb3JkIiwidWRpZCIsIlBhaXJSZWNvcmREYXRhIiwicGxpc3QiLCJwYXJzZVBsaXN0IiwiUGFpclJlY29yZElEIiwianNvbiIsIndyaXRlIiwicmVzcG9uc2VDYWxsYmFjayIsImUiLCJzZXRUaW1lb3V0IiwibGlzdERldmljZXMiLCJEZXZpY2VMaXN0IiwiZmluZERldmljZSIsImRldmljZXMiLCJmaW5kIiwiZGV2aWNlIiwiUHJvcGVydGllcyIsIlNlcmlhbE51bWJlciIsImNvbm5lY3RMb2NrZG93biIsImNvbm5lY3QiLCJEZXZpY2VJRCIsIkxPQ0tET1dOX1BPUlQiLCJMb2NrZG93biIsIlBsaXN0U2VydmljZSIsImRldmljZUlEIiwicG9ydCIsIk51bWJlciIsInNodXRkb3duIiwidW5waXBlIiwiUG9ydE51bWJlciIsImV4cG9ydHMiLCJfZGVmYXVsdCIsImRlZmF1bHQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvdXNibXV4L2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgcGxpc3QsIGZzIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBMZW5ndGhCYXNlZFNwbGl0dGVyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvbGVuZ3RoLWJhc2VkLXNwbGl0dGVyJztcbmltcG9ydCBVc2JtdXhEZWNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvdXNibXV4LWRlY29kZXIuanMnO1xuaW1wb3J0IFVzYm11eEVuY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci91c2JtdXgtZW5jb2Rlci5qcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBQbGlzdFNlcnZpY2UgZnJvbSAnLi4vcGxpc3Qtc2VydmljZSc7XG5pbXBvcnQgeyBMb2NrZG93biwgTE9DS0RPV05fUE9SVCB9IGZyb20gJy4uL2xvY2tkb3duJztcbmltcG9ydCB7IEJhc2VTZXJ2aWNlU29ja2V0IH0gZnJvbSAnLi4vYmFzZS1zZXJ2aWNlJztcbmltcG9ydCB7IE1CIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcblxuXG5jb25zdCBNQVhfRlJBTUVfU0laRSA9IDEgKiBNQjtcblxuY29uc3QgVVNCTVVYX1JFU1VMVCA9IHtcbiAgT0s6IDAsXG4gIEJBRENPTU1BTkQ6IDEsXG4gIEJBRERFVjogMixcbiAgQ09OTlJFRlVTRUQ6IDMsXG59O1xuXG5sZXQgbmFtZSwgdmVyc2lvbjtcbnRyeSB7XG4gIC8vIGZpcnN0IHRyeSBhc3N1bWluZyB0aGlzIGlzIGluIHRoZSBgYnVpbGRgIGZvbGRlclxuICAoeyBuYW1lLCB2ZXJzaW9uIH0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkpO1xufSBjYXRjaCAoZXJyKSB7XG4gIC8vIHRoZW4gdHJ5IGFzc3VtaW5nIGl0IGlzIG5vdFxuICAoeyBuYW1lLCB2ZXJzaW9uIH0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdwYWNrYWdlLmpzb24nKSkpO1xufVxuXG5jb25zdCBERUZBVUxUX1VTQk1VWERfU09DS0VUID0gJy92YXIvcnVuL3VzYm11eGQnO1xuY29uc3QgREVGQVVMVF9VU0JNVVhEX1BPUlQgPSAyNzAxNTtcbmNvbnN0IERFRkFVTFRfVVNCTVVYRF9IT1NUID0gJzEyNy4wLjAuMSc7XG5jb25zdCBQUk9HX05BTUUgPSBuYW1lO1xuY29uc3QgQ0xJRU5UX1ZFUlNJT05fU1RSSU5HID0gYCR7bmFtZX0tJHt2ZXJzaW9ufWA7XG5cbmZ1bmN0aW9uIHN3YXAxNiAodmFsKSB7XG4gIHJldHVybiAoKHZhbCAmIDB4RkYpIDw8IDgpIHwgKCh2YWwgPj4gOCkgJiAweEZGKTtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTb2NrZXRPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZz99IHNvY2tldFBhdGggWy92YXIvcnVuL3VzYm11eGRdIFRoZSBmdWxsIHBhdGggdG8gdGhlIHVzYm11eGQgVW5peCBzb2NrZXRcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyP30gc29ja2V0UG9ydCBbMjcwMTVdIFRoZSBwb3J0IG51bWJlciB0byBjb25uZWN0IHRvIGlmIHJ1bm5pbmcgb24gV2luZG93c1xuICogb3IgaW4gV1NMMSBtb2RlXG4gKiBAcHJvcGVydHkge3N0cmluZz99IHNvY2tldEhvc3QgWzEyNy4wLjAuMV0gVGhlIGhvc3QgbmFtZSB0byBjb25uZWN0IHRvIGlmIHJ1bm5pbmcgb24gV2luZG93c1xuICogb3IgaW4gV1NMMSBtb2RlXG4gKiBAcHJvcGVydHkge251bWJlcj99IHRpbWVvdXQgWzUwMDBdIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWxcbiAqIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkXG4gKi9cblxuLyoqXG4gKiBDb25uZWN0cyBhIHNvY2tldCB0byB1c2JtdXhkIHNlcnZpY2VcbiAqXG4gKiBAcGFyYW0ge1NvY2tldE9wdGlvbnM/fSBvcHRzXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGFjY2Vzc2luZyB0aGUgc29ja2V0IG9yXG4gKiBhIGNvbm5lY3Rpb24gZXJyb3IgaGFwcGVuZWRcbiAqIEB0aHJvd3Mge0IuVGltZW91dEVycm9yfSBpZiBjb25uZWN0aW9uIHRpbWVvdXQgaGFwcGVuZWRcbiAqIEByZXR1cm5zIHtpbXBvcnQoJ25ldCcpLlNvY2tldH0gQ29ubmVjdGVkIHNvY2tldCBpbnN0YW5jZVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXREZWZhdWx0U29ja2V0IChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHNvY2tldFBhdGggPSBERUZBVUxUX1VTQk1VWERfU09DS0VULFxuICAgIHNvY2tldFBvcnQgPSBERUZBVUxUX1VTQk1VWERfUE9SVCxcbiAgICBzb2NrZXRIb3N0ID0gREVGQVVMVF9VU0JNVVhEX0hPU1QsXG4gICAgdGltZW91dCA9IDUwMDAsXG4gIH0gPSBvcHRzO1xuXG4gIGxldCBzb2NrZXQ7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoc29ja2V0UGF0aCkpIHtcbiAgICBzb2NrZXQgPSBuZXQuY3JlYXRlQ29ubmVjdGlvbihzb2NrZXRQYXRoKTtcbiAgfSBlbHNlIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInXG4gICAgICB8fCAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ2xpbnV4JyAmJiAvbWljcm9zb2Z0L2kudGVzdChvcy5yZWxlYXNlKCkpKSkge1xuICAgIC8vIENvbm5lY3QgdG8gdXNibXV4ZCB3aGVuIHJ1bm5pbmcgb24gV1NMMVxuICAgIHNvY2tldCA9IG5ldC5jcmVhdGVDb25uZWN0aW9uKHNvY2tldFBvcnQsIHNvY2tldEhvc3QpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHVzYm11eGQgc29ja2V0IGF0ICcke3NvY2tldFBhdGh9JyBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBzb2NrZXQub25jZSgnZXJyb3InLCByZWplY3QpO1xuICAgIHNvY2tldC5vbmNlKCdjb25uZWN0JywgKCkgPT4gcmVzb2x2ZShzb2NrZXQpKTtcbiAgfSkudGltZW91dCh0aW1lb3V0KTtcbn1cblxuXG5jbGFzcyBVc2JtdXggZXh0ZW5kcyBCYXNlU2VydmljZVNvY2tldCB7XG4gIGNvbnN0cnVjdG9yIChzb2NrZXRDbGllbnQpIHtcbiAgICBzdXBlcihzb2NrZXRDbGllbnQpO1xuXG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBVc2JtdXhEZWNvZGVyKCk7XG4gICAgdGhpcy5fc3BsaXR0ZXIgPSBuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcih7XG4gICAgICByZWFkYWJsZVN0cmVhbTogc29ja2V0Q2xpZW50LFxuICAgICAgbGl0dGxlRW5kaWFuOiB0cnVlLFxuICAgICAgbWF4RnJhbWVMZW5ndGg6IE1BWF9GUkFNRV9TSVpFLFxuICAgICAgbGVuZ3RoRmllbGRPZmZzZXQ6IDAsXG4gICAgICBsZW5ndGhGaWVsZExlbmd0aDogNCxcbiAgICAgIGxlbmd0aEFkanVzdG1lbnQ6IDAsXG4gICAgfSk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50LnBpcGUodGhpcy5fc3BsaXR0ZXIpLnBpcGUodGhpcy5fZGVjb2Rlcik7XG5cbiAgICB0aGlzLl9lbmNvZGVyID0gbmV3IFVzYm11eEVuY29kZXIoKTtcbiAgICB0aGlzLl9lbmNvZGVyLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgICB0aGlzLl9hc3NpZ25DbGllbnRGYWlsdXJlSGFuZGxlcnModGhpcy5fZW5jb2Rlcik7XG5cbiAgICB0aGlzLl90YWcgPSAwO1xuICAgIHRoaXMuX3Jlc3BvbnNlQ2FsbGJhY2tzID0ge307XG4gICAgdGhpcy5fZGVjb2Rlci5vbignZGF0YScsIHRoaXMuX2hhbmRsZURhdGEuYmluZCh0aGlzKSk7XG4gIH1cblxuICBfaGFuZGxlRGF0YSAoZGF0YSkge1xuICAgIGNvbnN0IGNiID0gdGhpcy5fcmVzcG9uc2VDYWxsYmFja3NbZGF0YS5oZWFkZXIudGFnXSB8fCBfLm5vb3A7XG4gICAgY2IoZGF0YSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgQlVJRCBvZiB0aGUgaG9zdCBjb21wdXRlciBmcm9tIHVzYm11eGRcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gdXNibXV4ZFxuICAgKiBAcmV0dXJucyB7c3RyaW5nfVxuICAgKi9cbiAgYXN5bmMgcmVhZEJVSUQgKHRpbWVvdXQgPSA1MDAwKSB7XG4gICAgY29uc3Qge3RhZywgcmVjZWl2ZVByb21pc2V9ID0gdGhpcy5fcmVjZWl2ZVBsaXN0UHJvbWlzZSh0aW1lb3V0LCAoZGF0YSkgPT4ge1xuICAgICAgaWYgKGRhdGEucGF5bG9hZC5CVUlEKSB7XG4gICAgICAgIHJldHVybiBkYXRhLnBheWxvYWQuQlVJRDtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5fc2VuZFBsaXN0KHtcbiAgICAgIHRhZyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgTWVzc2FnZVR5cGU6ICdSZWFkQlVJRCcsXG4gICAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklOR1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF3YWl0IHJlY2VpdmVQcm9taXNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWRzIHRoZSBwYWlyIHJlY29yZCBvZiBhIGRldmljZS4gSXQgd2lsbCByZXR1cm4gbnVsbCBpZiBpdCBkb2Vzbid0IGV4aXN0c1xuICAgKiBAcGFyYW0ge3N0cmluZ30gdWRpZCB0aGUgdWRpZCBvZiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge09iamVjdD99XG4gICAqL1xuICBhc3luYyByZWFkUGFpclJlY29yZCAodWRpZCwgdGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCB7dGFnLCByZWNlaXZlUHJvbWlzZX0gPSB0aGlzLl9yZWNlaXZlUGxpc3RQcm9taXNlKHRpbWVvdXQsIChkYXRhKSA9PiB7XG4gICAgICBpZiAoIWRhdGEucGF5bG9hZC5QYWlyUmVjb3JkRGF0YSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBwbGlzdC5wYXJzZVBsaXN0KGRhdGEucGF5bG9hZC5QYWlyUmVjb3JkRGF0YSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLl9zZW5kUGxpc3Qoe1xuICAgICAgdGFnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBNZXNzYWdlVHlwZTogJ1JlYWRQYWlyUmVjb3JkJyxcbiAgICAgICAgUGFpclJlY29yZElEOiB1ZGlkLFxuICAgICAgICBQcm9nTmFtZTogUFJPR19OQU1FLFxuICAgICAgICBDbGllbnRWZXJzaW9uU3RyaW5nOiBDTElFTlRfVkVSU0lPTl9TVFJJTkdcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgcmVjZWl2ZVByb21pc2U7XG4gIH1cblxuICBfc2VuZFBsaXN0IChqc29uKSB7XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShqc29uKTtcbiAgfVxuXG4gIF9yZWNlaXZlUGxpc3RQcm9taXNlICh0aW1lb3V0ID0gNTAwMCwgcmVzcG9uc2VDYWxsYmFjaykge1xuICAgIGNvbnN0IHRhZyA9IHRoaXMuX3RhZysrO1xuICAgIGNvbnN0IHJlY2VpdmVQcm9taXNlID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5fcmVzcG9uc2VDYWxsYmFja3NbdGFnXSA9IChkYXRhKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmVzb2x2ZShyZXNwb25zZUNhbGxiYWNrKGRhdGEpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVqZWN0KG5ldyBFcnJvcihgRmFpbGVkIHRvIHJlY2VpdmUgYW55IGRhdGEgd2l0aGluIHRoZSB0aW1lb3V0OiAke3RpbWVvdXR9YCkpLCB0aW1lb3V0KTtcbiAgICB9KTtcbiAgICByZXR1cm4ge3RhZywgcmVjZWl2ZVByb21pc2V9O1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIGFsbCBkZXZpY2VzIGNvbm5lY3RlZCB0byB0aGUgaG9zdFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHtBcnJheX1cbiAgICovXG4gIGFzeW5jIGxpc3REZXZpY2VzICh0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IHt0YWcsIHJlY2VpdmVQcm9taXNlfSA9IHRoaXMuX3JlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCwgKGRhdGEpID0+IHtcbiAgICAgIGlmIChkYXRhLnBheWxvYWQuRGV2aWNlTGlzdCkge1xuICAgICAgICByZXR1cm4gZGF0YS5wYXlsb2FkLkRldmljZUxpc3Q7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9KTtcblxuICAgIHRoaXMuX3NlbmRQbGlzdCh7XG4gICAgICB0YWcsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIE1lc3NhZ2VUeXBlOiAnTGlzdERldmljZXMnLFxuICAgICAgICBQcm9nTmFtZTogUFJPR19OQU1FLFxuICAgICAgICBDbGllbnRWZXJzaW9uU3RyaW5nOiBDTElFTlRfVkVSU0lPTl9TVFJJTkdcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb29rcyBmb3IgYSBkZXZpY2Ugd2l0aCB0aGUgcGFzc2VkIHVkaWQuIEl0IHdpbGwgcmV0dXJuIHVuZGVmaW5lZCBpZiB0aGUgZGV2aWNlIGlzIG5vdCBmb3VuZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdWRpZCB0aGUgdWRpZCBvZiB0aGUgZGV2aWNlXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge09iamVjdD99XG4gICAqL1xuICBhc3luYyBmaW5kRGV2aWNlICh1ZGlkLCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IGRldmljZXMgPSBhd2FpdCB0aGlzLmxpc3REZXZpY2VzKHRpbWVvdXQpO1xuICAgIHJldHVybiBfLmZpbmQoZGV2aWNlcywgKGRldmljZSkgPT4gZGV2aWNlLlByb3BlcnRpZXMuU2VyaWFsTnVtYmVyID09PSB1ZGlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0cyB0byB0aGUgbG9ja2Rvd25kIG9uIHRoZSBkZXZpY2UgYW5kIHJldHVybnMgYSBMb2NrZG93biBjbGllbnRcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgdGhlIHVkaWQgb2YgdGhlIGRldmljZVxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSB1c2JtdXhkXG4gICAqIEByZXR1cm5zIHtMb2NrZG93bn1cbiAgICovXG4gIGFzeW5jIGNvbm5lY3RMb2NrZG93biAodWRpZCwgdGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBkZXZpY2UgPSBhd2FpdCB0aGlzLmZpbmREZXZpY2UodWRpZCwgdGltZW91dCk7XG4gICAgaWYgKCFkZXZpY2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgdGhlIGV4cGVjdGVkIGRldmljZSAnJHt1ZGlkfSdgKTtcbiAgICB9XG4gICAgY29uc3Qgc29ja2V0ID0gYXdhaXQgdGhpcy5jb25uZWN0KGRldmljZS5Qcm9wZXJ0aWVzLkRldmljZUlELCBMT0NLRE9XTl9QT1JULCB0aW1lb3V0KTtcbiAgICByZXR1cm4gbmV3IExvY2tkb3duKG5ldyBQbGlzdFNlcnZpY2Uoc29ja2V0KSk7XG4gIH1cblxuICAvKipcbiAgICogQ29ubmVjdHMgdG8gYSBjZXJ0YWluIHBvcnQgb24gdGhlIGRldmljZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gZGV2aWNlSUQgdGhlIGRldmljZSBpZCB3aGljaCBjYW4gYmUgcmV0cmlldmVkIGZyb20gdGhlIHByb3BlcnRpZXMgb2YgYSBkZXZpY2VcbiAgICogQHBhcmFtIHtudW1iZXJ9IHBvcnQgdGhlIHBvcnQgbnVtYmVyIHRoYXQgd2FudHMgdG8gYmUgY29ubmVjdGVkXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIHVzYm11eGRcbiAgICogQHJldHVybnMge25ldC5Tb2NrZXR8T2JqZWN0fSBUaGUgc29ja2V0IG9yIHRoZSBvYmplY3QgcmV0dXJuZWQgaW4gdGhlIGNhbGxiYWNrIGlmIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBleGlzdHNcbiAgICovXG4gIGFzeW5jIGNvbm5lY3QgKGRldmljZUlELCBwb3J0LCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IHt0YWcsIHJlY2VpdmVQcm9taXNlfSA9IHRoaXMuX3JlY2VpdmVQbGlzdFByb21pc2UodGltZW91dCwgKGRhdGEpID0+IHtcbiAgICAgIGlmIChkYXRhLnBheWxvYWQuTWVzc2FnZVR5cGUgIT09ICdSZXN1bHQnKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgfVxuICAgICAgaWYgKGRhdGEucGF5bG9hZC5OdW1iZXIgPT09IFVTQk1VWF9SRVNVTFQuT0spIHtcbiAgICAgICAgdGhpcy5fc3BsaXR0ZXIuc2h1dGRvd24oKTtcbiAgICAgICAgdGhpcy5fc29ja2V0Q2xpZW50LnVucGlwZSh0aGlzLl9zcGxpdHRlcik7XG4gICAgICAgIHRoaXMuX3NwbGl0dGVyLnVucGlwZSh0aGlzLl9kZWNvZGVyKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NvY2tldENsaWVudDtcbiAgICAgIH0gZWxzZSBpZiAoZGF0YS5wYXlsb2FkLk51bWJlciA9PT0gVVNCTVVYX1JFU1VMVC5DT05OUkVGVVNFRCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvbm5lY3Rpb24gd2FzIHJlZnVzZWQgdG8gcG9ydCAke3BvcnR9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuX3NlbmRQbGlzdCh7XG4gICAgICB0YWcsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIE1lc3NhZ2VUeXBlOiAnQ29ubmVjdCcsXG4gICAgICAgIFByb2dOYW1lOiBQUk9HX05BTUUsXG4gICAgICAgIENsaWVudFZlcnNpb25TdHJpbmc6IENMSUVOVF9WRVJTSU9OX1NUUklORyxcbiAgICAgICAgRGV2aWNlSUQ6IGRldmljZUlELFxuICAgICAgICBQb3J0TnVtYmVyOiBzd2FwMTYocG9ydClcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBhd2FpdCByZWNlaXZlUHJvbWlzZTtcbiAgfVxufVxuXG5leHBvcnQgeyBVc2JtdXgsIGdldERlZmF1bHRTb2NrZXQgfTtcbmV4cG9ydCBkZWZhdWx0IFVzYm11eDtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsSUFBQUEsSUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsR0FBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUUsT0FBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUcsU0FBQSxHQUFBSixzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUksUUFBQSxHQUFBSixPQUFBO0FBQ0EsSUFBQUssb0JBQUEsR0FBQU4sc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFNLGNBQUEsR0FBQVAsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFPLGNBQUEsR0FBQVIsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFRLEtBQUEsR0FBQVQsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFTLGFBQUEsR0FBQVYsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFVLFNBQUEsR0FBQVYsT0FBQTtBQUNBLElBQUFXLFlBQUEsR0FBQVgsT0FBQTtBQUNBLElBQUFZLFVBQUEsR0FBQVosT0FBQTtBQUdBLE1BQU1hLGNBQWMsR0FBRyxDQUFDLEdBQUdDLGFBQUU7QUFFN0IsTUFBTUMsYUFBYSxHQUFHO0VBQ3BCQyxFQUFFLEVBQUUsQ0FBQztFQUNMQyxVQUFVLEVBQUUsQ0FBQztFQUNiQyxNQUFNLEVBQUUsQ0FBQztFQUNUQyxXQUFXLEVBQUU7QUFDZixDQUFDO0FBRUQsSUFBSUMsSUFBSSxFQUFFQyxPQUFPO0FBQ2pCLElBQUk7RUFFRixDQUFDO0lBQUVELElBQUk7SUFBRUM7RUFBUSxDQUFDLEdBQUdyQixPQUFPLENBQUNzQixhQUFJLENBQUNDLE9BQU8sQ0FBQ0MsU0FBUyxFQUFF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