"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Xctest = void 0;
require("source-map-support/register");
var _services = require("./services");
var _instrument = require("./instrument");
var _headers = require("./instrument/headers");
var _nskeyed = require("./instrument/transformer/nskeyed");
var _testmanagerd = require("./testmanagerd");
var _support = require("@appium/support");
var _utilities = require("./utilities");
var _logger = _interopRequireDefault(require("./logger"));
var _bluebird = _interopRequireDefault(require("bluebird"));
const {
  DAEMON_CONNECTION_INTERFACE
} = _testmanagerd.TESTMANAGERD_CHANNEL;
const XCTEST_CONFIGURATION_EXTENSION = '.xctestconfiguration';
const TMP_FOLDER_PREFIX = '/tmp';
const XCTEST_EXECUTABLE_SUFFIX = '-Runner';
const MAJOR_IOS_VERSION_9 = 9;
const MAJOR_IOS_VERSION_11 = 11;
const MAJOR_IOS_VERSION_12 = 12;
const XCODE_BUILD_PATH = '/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild';
const XCODE_VERSION = 29;
const MAGIC_CHANNEL = 0xFFFFFFFF;
class Xctest {
  constructor(udid, xctestBundleId, targetBundleId = null, opts = {}) {
    this.udid = udid;
    this.running = false;
    this._executing = false;
    this.xctestBundleId = xctestBundleId;
    this.targetBundleId = targetBundleId;
    this._conf = (opts === null || opts === void 0 ? void 0 : opts.conf) || {};
    this._env = (opts === null || opts === void 0 ? void 0 : opts.env) || {};
  }
  async _launchAppRunner(majorVersion, sessionIdentifier) {
    const {
      PROCESS_CONTROL
    } = _instrument.INSTRUMENT_CHANNEL;
    const installation = await (0, _services.startInstallationProxyService)(this.udid);
    let lookupResult;
    try {
      lookupResult = await installation.lookupApplications({
        bundleIds: [this.xctestBundleId]
      });
    } finally {
      installation.close();
    }
    const appInfo = lookupResult[this.xctestBundleId];
    if (!appInfo) {
      throw new Error(`${this.xctestBundleId} not found on device ${this.udid}`);
    }
    const signerIdentifier = appInfo.SignerIdentity;
    _logger.default.info(`SignerIdentifier: ${signerIdentifier}`);
    const appContainer = appInfo.Container;
    const execName = appInfo.CFBundleExecutable;
    if (!execName.endsWith(XCTEST_EXECUTABLE_SUFFIX)) {
      throw new Error(`Invalid CFBundleExecutable ${execName} from ${this.xctestBundleId}, is this bundle a valid xctest app?`);
    }
    const targetName = execName.substr(0, execName.indexOf(XCTEST_EXECUTABLE_SUFFIX));
    const xctestPath = `${TMP_FOLDER_PREFIX}/${targetName}-${sessionIdentifier.toUpperCase()}${XCTEST_CONFIGURATION_EXTENSION}`;
    const xctestConfiguration = new _nskeyed.XCTestConfiguration({
      ...this._conf,
      testBundleURL: `file://${appInfo.Path}/PlugIns/${targetName}.xctest`,
      sessionIdentifier,
      targetApplicationBundleID: this.targetBundleId
    });
    await this._writeConfigurationToDevice(xctestConfiguration, xctestPath);
    this._instrumentService = await (0, _services.startInstrumentService)(this.udid);
    this._instrumentService.registerLifecycleCallback('close', this.stop.bind(this));
    await this._instrumentService.callChannel(PROCESS_CONTROL, 'processIdentifierForBundleIdentifier:', this.xctestBundleId);
    const appPath = appInfo.Path;
    const xctestConfigurationPath = appContainer + xctestPath;
    const appEnv = {
      CA_ASSERT_MAIN_THREAD_TRANSACTIONS: '0',
      CA_DEBUG_TRANSACTIONS: '0',
      DYLD_FRAMEWORK_PATH: `${appPath}/Frameworks:`,
      DYLD_LIBRARY_PATH: `${appPath}/Frameworks`,
      NSUnbufferedIO: 'YES',
      SQLITE_ENABLE_THREAD_ASSERTIONS: '1',
      WDA_PRODUCT_BUNDLE_IDENTIFIER: '',
      XCTestConfigurationFilePath: xctestConfigurationPath,
      XCODE_DBG_XPC_EXCLUSIONS: 'com.apple.dt.xctestSymbolicator',
      MJPEG_SERVER_PORT: '',
      USE_PORT: '',
      LLVM_PROFILE_FILE: `${appContainer}/tmp/%p.profraw`,
      ...this._env
    };
    if (majorVersion >= MAJOR_IOS_VERSION_11) {
      appEnv.DYLD_INSERT_LIBRARIES = '/Developer/usr/lib/libMainThreadChecker.dylib';
      appEnv.OS_ACTIVITY_DT_MODE = 'YES';
    }
    const appArgs = ['-NSTreatUnknownArgumentsAsOpen', 'NO', '-ApplePersistenceIgnoreState', 'YES'];
    const appOptions = {
      StartSuspendedKey: false
    };
    if (majorVersion >= MAJOR_IOS_VERSION_12) {
      appOptions.ActivateSuspended = true;
    }
    const launchResult = await this._instrumentService.callChannel(PROCESS_CONTROL, 'launchSuspendedProcessWithDevicePath:bundleIdentifier:environment:arguments:options:', appPath, this.xctestBundleId, appEnv, appArgs, appOptions);
    const pid = launchResult.selector;
    if (typeof pid !== 'number') {
      throw Error(`Failed on launching ${this.xctestBundleId}: ${launchResult}`);
    }
    _logger.default.info(`Pid of launched ${this.xctestBundleId}: ${pid}`);
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(pid);
    await this._instrumentService.callChannel(PROCESS_CONTROL, 'startObservingPid:', msg);
    return pid;
  }
  async _writeConfigurationToDevice(xctestConfiguration, xctestPath) {
    const xctestContent = xctestConfiguration.getBytes();
    const houseArrestService = await (0, _services.startHouseArrestService)(this.udid);
    let vendContainer;
    let stream;
    try {
      vendContainer = await houseArrestService.vendContainer(this.xctestBundleId);
      const list = await vendContainer.listDirectory(TMP_FOLDER_PREFIX);
      for (const file of list) {
        if (file.endsWith(XCTEST_CONFIGURATION_EXTENSION)) {
          const fullPath = `${TMP_FOLDER_PREFIX}/${file}`;
          _logger.default.debug(`removing ${fullPath}`);
          await vendContainer.deleteDirectory(fullPath);
        }
      }
      stream = await vendContainer.createWriteStream(xctestPath, {});
      await new _bluebird.default((resolve, reject) => {
        stream.write(xctestContent, resolve);
        stream.on('error', reject);
      });
    } finally {
      var _stream, _vendContainer;
      (_stream = stream) === null || _stream === void 0 ? void 0 : _stream.end();
      (_vendContainer = vendContainer) === null || _vendContainer === void 0 ? void 0 : _vendContainer.close();
      houseArrestService.close();
    }
  }
  async _startInitialSession(majorVersion) {
    this._initialControlSession = await (0, _services.startTestmanagerdService)(this.udid);
    this._initialControlSession.registerLifecycleCallback('close', this.stop.bind(this));
    if (majorVersion < MAJOR_IOS_VERSION_11) {
      return;
    }
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(XCODE_VERSION);
    await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateControlSessionWithProtocolVersion:', msg);
  }
  async _startExecSession(sessionIdentifier) {
    this._execTestPlanSession = await (0, _services.startTestmanagerdService)(this.udid);
    this._execTestPlanSession.registerLifecycleCallback('close', this.stop.bind(this));
    const startExecuting = () => {
      if (this._executing) {
        return;
      }
      this._executing = true;
      const msg = new _headers.DTXMessageAuxBuffer();
      msg.appendObject(XCODE_VERSION);
      this._execTestPlanSession._callChannel(false, MAGIC_CHANNEL, '_IDE_startExecutingTestPlanWithProtocolVersion:', msg);
    };
    const showLogMessage = message => {
      if (message.auxiliaries.join('').includes('Received test runner ready reply with error: (null')) {
        _logger.default.info('Test runner ready');
        setTimeout(() => startExecuting(), 1000);
      }
    };
    this._execTestPlanSession.registerSelectorCallback('_XCT_testBundleReadyWithProtocolVersion:minimumVersion:', startExecuting);
    this._execTestPlanSession.registerSelectorCallback('_XCT_logDebugMessage:', showLogMessage);
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(new _nskeyed.NSUUID(sessionIdentifier));
    msg.appendObject(`${sessionIdentifier}-746F-006D726964646C79`);
    msg.appendObject(XCODE_BUILD_PATH);
    msg.appendObject(XCODE_VERSION);
    await this._execTestPlanSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateSessionWithIdentifier:forClient:atPath:protocolVersion:', msg);
  }
  async _notifyTestProcessId(pid, majorVersion) {
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(pid);
    if (majorVersion >= MAJOR_IOS_VERSION_12) {
      return await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_authorizeTestSessionWithProcessID:', msg);
    }
    if (majorVersion <= MAJOR_IOS_VERSION_9) {
      return await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateControlSessionForTestProcessID:', msg);
    }
    msg.appendObject(XCODE_VERSION);
    return await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateControlSessionForTestProcessID:protocolVersion:', msg);
  }
  async start() {
    if (this.running) {
      const targetMessage = this.targetBundleId ? `(targeting ${this.targetBundleId})` : '';
      const message = `Xctest for ${this.xctestBundleId}${targetMessage} on device ${this.udid} is already running!`;
      _logger.default.info(`${message} Doing nothing here`);
      return;
    }
    this.running = true;
    try {
      const productVersion = await (0, _utilities.getOSVersion)(this.udid);
      const majorVersion = parseInt(productVersion.split('.')[0], 10);
      const sessionIdentifier = _support.util.uuidV4();
      await this._startInitialSession(majorVersion);
      await this._startExecSession(sessionIdentifier);
      const pid = await this._launchAppRunner(majorVersion, sessionIdentifier);
      await this._notifyTestProcessId(pid, majorVersion);
    } catch (e) {
      this.stop();
      throw e;
    }
  }
  stop() {
    var _this$_instrumentServ, _this$_instrumentServ2, _this$_execTestPlanSe, _this$_execTestPlanSe2, _this$_initialControl, _this$_initialControl2;
    if (!this.running) {
      return;
    }
    this.running = false;
    (_this$_instrumentServ = this._instrumentService) === null || _this$_instrumentServ === void 0 ? void 0 : _this$_instrumentServ.close();
    (_this$_instrumentServ2 = this._instrumentService) === null || _this$_instrumentServ2 === void 0 ? void 0 : _this$_instrumentServ2.dispose();
    this._instrumentService = undefined;
    (_this$_execTestPlanSe = this._execTestPlanSession) === null || _this$_execTestPlanSe === void 0 ? void 0 : _this$_execTestPlanSe.close();
    (_this$_execTestPlanSe2 = this._execTestPlanSession) === null || _this$_execTestPlanSe2 === void 0 ? void 0 : _this$_execTestPlanSe2.dispose();
    this._execTestPlanSession = undefined;
    (_this$_initialControl = this._initialControlSession) === null || _this$_initialControl === void 0 ? void 0 : _this$_initialControl.close();
    (_this$_initialControl2 = this._initialControlSession) === null || _this$_initialControl2 === void 0 ? void 0 : _this$_initialControl2.dispose();
    this._initialControlSession = undefined;
    this._executing = false;
    const targetMessage = this.targetBundleId ? `(targeting ${this.targetBundleId})` : '';
    const message = `Xctest for ${this.xctestBundleId}${targetMessage} on device ${this.udid} has stopped!`;
    _logger.default.debug(message);
  }
}
exports.Xctest = Xctest;
var _default = Xctest;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc2VydmljZXMiLCJyZXF1aXJlIiwiX2luc3RydW1lbnQiLCJfaGVhZGVycyIsIl9uc2tleWVkIiwiX3Rlc3RtYW5hZ2VyZCIsIl9zdXBwb3J0IiwiX3V0aWxpdGllcyIsIl9sb2dnZXIiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2JsdWViaXJkIiwiREFFTU9OX0NPTk5FQ1RJT05fSU5URVJGQUNFIiwiVEVTVE1BTkFHRVJEX0NIQU5ORUwiLCJYQ1RFU1RfQ09ORklHVVJBVElPTl9FWFRFTlNJT04iLCJUTVBfRk9MREVSX1BSRUZJWCIsIlhDVEVTVF9FWEVDVVRBQkxFX1NVRkZJWCIsIk1BSk9SX0lPU19WRVJTSU9OXzkiLCJNQUpPUl9JT1NfVkVSU0lPTl8xMSIsIk1BSk9SX0lPU19WRVJTSU9OXzEyIiwiWENPREVfQlVJTERfUEFUSCIsIlhDT0RFX1ZFUlNJT04iLCJNQUdJQ19DSEFOTkVMIiwiWGN0ZXN0IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGN0ZXN0QnVuZGxlSWQiLCJ0YXJnZXRCdW5kbGVJZCIsIm9wdHMiLCJydW5uaW5nIiwiX2V4ZWN1dGluZyIsIl9jb25mIiwiY29uZiIsIl9lbnYiLCJlbnYiLCJfbGF1bmNoQXBwUnVubmVyIiwibWFqb3JWZXJzaW9uIiwic2Vzc2lvbklkZW50aWZpZXIiLCJQUk9DRVNTX0NPTlRST0wiLCJJTlNUUlVNRU5UX0NIQU5ORUwiLCJpbnN0YWxsYXRpb24iLCJzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSIsImxvb2t1cFJlc3VsdCIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsImNsb3NlIiwiYXBwSW5mbyIsIkVycm9yIiwic2lnbmVySWRlbnRpZmllciIsIlNpZ25lcklkZW50aXR5IiwibG9nIiwiaW5mbyIsImFwcENvbnRhaW5lciIsIkNvbnRhaW5lciIsImV4ZWNOYW1lIiwiQ0ZCdW5kbGVFeGVjdXRhYmxlIiwiZW5kc1dpdGgiLCJ0YXJnZXROYW1lIiwic3Vic3RyIiwiaW5kZXhPZiIsInhjdGVzdFBhdGgiLCJ0b1VwcGVyQ2FzZSIsInhjdGVzdENvbmZpZ3VyYXRpb24iLCJYQ1Rlc3RDb25maWd1cmF0aW9uIiwidGVzdEJ1bmRsZVVSTCIsIlBhdGgiLCJ0YXJnZXRBcHBsaWNhdGlvbkJ1bmRsZUlEIiwiX3dyaXRlQ29uZmlndXJhdGlvblRvRGV2aWNlIiwiX2luc3RydW1lbnRTZXJ2aWNlIiwic3RhcnRJbnN0cnVtZW50U2VydmljZSIsInJlZ2lzdGVyTGlmZWN5Y2xlQ2FsbGJhY2siLCJzdG9wIiwiYmluZCIsImNhbGxDaGFubmVsIiwiYXBwUGF0aCIsInhjdGVzdENvbmZpZ3VyYXRpb25QYXRoIiwiYXBwRW52IiwiQ0FfQVNTRVJUX01BSU5fVEhSRUFEX1RSQU5TQUNUSU9OUyIsIkNBX0RFQlVHX1RSQU5TQUNUSU9OUyIsIkRZTERfRlJBTUVXT1JLX1BBVEgiLCJEWUxEX0xJQlJBUllfUEFUSCIsIk5TVW5idWZmZXJlZElPIiwiU1FMSVRFX0VOQUJMRV9USFJFQURfQVNTRVJUSU9OUyIsIldEQV9QUk9EVUNUX0JVTkRMRV9JREVOVElGSUVSIiwiWENUZXN0Q29uZmlndXJhdGlvbkZpbGVQYXRoIiwiWENPREVfREJHX1hQQ19FWENMVVNJT05TIiwiTUpQRUdfU0VSVkVSX1BPUlQiLCJVU0VfUE9SVCIsIkxMVk1fUFJPRklMRV9GSUxFIiwiRFlMRF9JTlNFUlRfTElCUkFSSUVTIiwiT1NfQUNUSVZJVFlfRFRfTU9ERSIsImFwcEFyZ3MiLCJhcHBPcHRpb25zIiwiU3RhcnRTdXNwZW5kZWRLZXkiLCJBY3RpdmF0ZVN1c3BlbmRlZCIsImxhdW5jaFJlc3VsdCIsInBpZCIsInNlbGVjdG9yIiwibXNnIiwiRFRYTWVzc2FnZUF1eEJ1ZmZlciIsImFwcGVuZE9iamVjdCIsInhjdGVzdENvbnRlbnQiLCJnZXRCeXRlcyIsImhvdXNlQXJyZXN0U2VydmljZSIsInN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlIiwidmVuZENvbnRhaW5lciIsInN0cmVhbSIsImxpc3QiLCJsaXN0RGlyZWN0b3J5IiwiZmlsZSIsImZ1bGxQYXRoIiwiZGVidWciLCJkZWxldGVEaXJlY3RvcnkiLCJjcmVhdGVXcml0ZVN0cmVhbSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0Iiwid3JpdGUiLCJvbiIsIl9zdHJlYW0iLCJfdmVuZENvbnRhaW5lciIsImVuZCIsIl9zdGFydEluaXRpYWxTZXNzaW9uIiwiX2luaXRpYWxDb250cm9sU2Vzc2lvbiIsInN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSIsIl9zdGFydEV4ZWNTZXNzaW9uIiwiX2V4ZWNUZXN0UGxhblNlc3Npb24iLCJzdGFydEV4ZWN1dGluZyIsIl9jYWxsQ2hhbm5lbCIsInNob3dMb2dNZXNzYWdlIiwibWVzc2FnZSIsImF1eGlsaWFyaWVzIiwiam9pbiIsImluY2x1ZGVzIiwic2V0VGltZW91dCIsInJlZ2lzdGVyU2VsZWN0b3JDYWxsYmFjayIsIk5TVVVJRCIsIl9ub3RpZnlUZXN0UHJvY2Vzc0lkIiwic3RhcnQiLCJ0YXJnZXRNZXNzYWdlIiwicHJvZHVjdFZlcnNpb24iLCJnZXRPU1ZlcnNpb24iLCJwYXJzZUludCIsInNwbGl0IiwidXRpbCIsInV1aWRWNCIsImUiLCJfdGhpcyRfaW5zdHJ1bWVudFNlcnYiLCJfdGhpcyRfaW5zdHJ1bWVudFNlcnYyIiwiX3RoaXMkX2V4ZWNUZXN0UGxhblNlIiwiX3RoaXMkX2V4ZWNUZXN0UGxhblNlMiIsIl90aGlzJF9pbml0aWFsQ29udHJvbCIsIl90aGlzJF9pbml0aWFsQ29udHJvbDIiLCJkaXNwb3NlIiwidW5kZWZpbmVkIiwiZXhwb3J0cyIsIl9kZWZhdWx0IiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi94Y3Rlc3QuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3RhcnRIb3VzZUFycmVzdFNlcnZpY2UsIHN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSwgc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UsIHN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzJztcbmltcG9ydCB7IElOU1RSVU1FTlRfQ0hBTk5FTCB9IGZyb20gJy4vaW5zdHJ1bWVudCc7XG5pbXBvcnQgeyBEVFhNZXNzYWdlQXV4QnVmZmVyIH0gZnJvbSAnLi9pbnN0cnVtZW50L2hlYWRlcnMnO1xuaW1wb3J0IHsgTlNVVUlELCBYQ1Rlc3RDb25maWd1cmF0aW9uIH0gZnJvbSAnLi9pbnN0cnVtZW50L3RyYW5zZm9ybWVyL25za2V5ZWQnO1xuaW1wb3J0IHsgVEVTVE1BTkFHRVJEX0NIQU5ORUwgfSBmcm9tICcuL3Rlc3RtYW5hZ2VyZCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGdldE9TVmVyc2lvbiB9IGZyb20gJy4vdXRpbGl0aWVzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5jb25zdCB7IERBRU1PTl9DT05ORUNUSU9OX0lOVEVSRkFDRSB9ID0gVEVTVE1BTkFHRVJEX0NIQU5ORUw7XG5jb25zdCBYQ1RFU1RfQ09ORklHVVJBVElPTl9FWFRFTlNJT04gPSAnLnhjdGVzdGNvbmZpZ3VyYXRpb24nO1xuY29uc3QgVE1QX0ZPTERFUl9QUkVGSVggPSAnL3RtcCc7XG5jb25zdCBYQ1RFU1RfRVhFQ1VUQUJMRV9TVUZGSVggPSAnLVJ1bm5lcic7XG5jb25zdCBNQUpPUl9JT1NfVkVSU0lPTl85ID0gOTtcbmNvbnN0IE1BSk9SX0lPU19WRVJTSU9OXzExID0gMTE7XG5jb25zdCBNQUpPUl9JT1NfVkVSU0lPTl8xMiA9IDEyO1xuLy9UaGlzIGlzIG5vdCByZWxhdGVkIHdpdGggd2hpY2ggeGNvZGUgdXNlciBpbnN0YWxsZWQgYnV0IG9ubHkgYSBtYXJrZXIgdG8gdXNlIGluc2lkZSBkZXZpY2VcbmNvbnN0IFhDT0RFX0JVSUxEX1BBVEggPSAnL0FwcGxpY2F0aW9ucy9YY29kZS5hcHAvQ29udGVudHMvRGV2ZWxvcGVyL3Vzci9iaW4veGNvZGVidWlsZCc7XG5jb25zdCBYQ09ERV9WRVJTSU9OID0gMjk7XG5jb25zdCBNQUdJQ19DSEFOTkVMID0gMHhGRkZGRkZGRjtcbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gWENUZXN0Q29uZmlndXJhdGlvblByb3BlcnRpZXNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gcHJvZHVjdE1vZHVsZU5hbWVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nW10/fSB0YXJnZXRBcHBsaWNhdGlvbkFyZ3VtZW50c1xuICogQHByb3BlcnR5IHtzdHJpbmdbXT99IHRlc3RzVG9SdW5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nW10/fSB0ZXN0c1RvU2tpcFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gWGN0ZXN0T3B0aW9uXG4gKiBAcHJvcGVydHkge1hDVGVzdENvbmZpZ3VyYXRpb25Qcm9wZXJ0aWVzfSBjb25mIHByb3BlcnRpZXMgdG8gb3ZlcnJpZGUgaW4gWENUZXN0Q29uZmlndXJhdGlvblxuICogQHByb3BlcnR5IHtvYmplY3R9IGVudiBrZXktdmFsdWUgcGFpcnMgdG8gYXBwZW5kIGluIHhjdGVzdCBhcHAgZW52aXJvbm1lbnRcbiAqL1xuXG4vKipcbiAqIEFsbG93cyBpbnZva2luZyBwcmUtaW5zdGFsbGVkIHhjdGVzdCBhcHAgZnJvbSBpT1MgZGV2aWNlcy4gTm8gWGNvZGUgaW5zdGFsbGF0aW9uIGlzIHJlcXVpcmVkLlxuICogVGhpcyBjbGFzcyBzaW11bGF0ZXMgdGhlIHByb2NlZHVyZSB3aGljaCB4Y29kZSB1c2VzIHRvIGludm9rZSB4Y3Rlc3RzLlxuICovXG5jbGFzcyBYY3Rlc3Qge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgRGV2aWNlIHVkaWQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHhjdGVzdEJ1bmRsZUlkIEJ1bmRsZSBJZCBvZiB4Y3Rlc3QgYXBwIG9uIGRldmljZS4gVGhlIGFwcCBtdXN0IGJlIGluc3RhbGxlZCBvbiBkZXZpY2UuXG4gICAgICogQHBhcmFtIHtzdHJpbmc/fSB0YXJnZXRCdW5kbGVJZCB0ZXN0IHRhcmdldCBidW5kbGUgaWQuXG4gICAgICogQHBhcmFtIHtYY3Rlc3RPcHRpb24/fSBvcHRzIGFkZGl0aW9uIG9wdGlvbnMgdG8gc3BlY2lmaWMgWENUZXN0Q29uZmlndXJhdGlvbiBhbmQgYXBwIGxhdW5jaCBlbnZcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcih1ZGlkLCB4Y3Rlc3RCdW5kbGVJZCwgdGFyZ2V0QnVuZGxlSWQgPSBudWxsLCBvcHRzID0ge30pIHtcbiAgICAgICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2V4ZWN1dGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnhjdGVzdEJ1bmRsZUlkID0geGN0ZXN0QnVuZGxlSWQ7XG4gICAgICAgIHRoaXMudGFyZ2V0QnVuZGxlSWQgPSB0YXJnZXRCdW5kbGVJZDtcbiAgICAgICAgdGhpcy5fY29uZiA9IG9wdHM/LmNvbmYgfHwge307XG4gICAgICAgIHRoaXMuX2VudiA9IG9wdHM/LmVudiB8fCB7fTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWFqb3JWZXJzaW9uIGZpcnN0IHBhcnQgb2YgaU9TIHZlcnNpb24gOS8xMC8xMS8xMi8xMy8xNC8xNS8xNlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWRlbnRpZmllciB1dWlkIHdpdGggZm9ybWF0OiAwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDBcbiAgICAgKi9cbiAgICBhc3luYyBfbGF1bmNoQXBwUnVubmVyKG1ham9yVmVyc2lvbiwgc2Vzc2lvbklkZW50aWZpZXIpIHtcbiAgICAgICAgY29uc3QgeyBQUk9DRVNTX0NPTlRST0wgfSA9IElOU1RSVU1FTlRfQ0hBTk5FTDtcbiAgICAgICAgY29uc3QgaW5zdGFsbGF0aW9uID0gYXdhaXQgc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgICAgbGV0IGxvb2t1cFJlc3VsdDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxvb2t1cFJlc3VsdCA9IGF3YWl0IGluc3RhbGxhdGlvbi5sb29rdXBBcHBsaWNhdGlvbnMoeyBidW5kbGVJZHM6IFt0aGlzLnhjdGVzdEJ1bmRsZUlkXSB9KTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGluc3RhbGxhdGlvbi5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFwcEluZm8gPSBsb29rdXBSZXN1bHRbdGhpcy54Y3Rlc3RCdW5kbGVJZF07XG4gICAgICAgIGlmICghYXBwSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMueGN0ZXN0QnVuZGxlSWR9IG5vdCBmb3VuZCBvbiBkZXZpY2UgJHt0aGlzLnVkaWR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2lnbmVySWRlbnRpZmllciA9IGFwcEluZm8uU2lnbmVySWRlbnRpdHk7XG4gICAgICAgIGxvZy5pbmZvKGBTaWduZXJJZGVudGlmaWVyOiAke3NpZ25lcklkZW50aWZpZXJ9YCk7XG4gICAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGFwcEluZm8uQ29udGFpbmVyO1xuICAgICAgICBjb25zdCBleGVjTmFtZSA9IGFwcEluZm8uQ0ZCdW5kbGVFeGVjdXRhYmxlO1xuICAgICAgICBpZiAoIWV4ZWNOYW1lLmVuZHNXaXRoKFhDVEVTVF9FWEVDVVRBQkxFX1NVRkZJWCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBDRkJ1bmRsZUV4ZWN1dGFibGUgJHtleGVjTmFtZX0gZnJvbSAke3RoaXMueGN0ZXN0QnVuZGxlSWR9LCBpcyB0aGlzIGJ1bmRsZSBhIHZhbGlkIHhjdGVzdCBhcHA/YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGFyZ2V0TmFtZSA9IGV4ZWNOYW1lLnN1YnN0cigwLCBleGVjTmFtZS5pbmRleE9mKFhDVEVTVF9FWEVDVVRBQkxFX1NVRkZJWCkpO1xuICAgICAgICBjb25zdCB4Y3Rlc3RQYXRoID0gYCR7VE1QX0ZPTERFUl9QUkVGSVh9LyR7dGFyZ2V0TmFtZX0tJHtzZXNzaW9uSWRlbnRpZmllci50b1VwcGVyQ2FzZSgpfSR7WENURVNUX0NPTkZJR1VSQVRJT05fRVhURU5TSU9OfWA7XG4gICAgICAgIGNvbnN0IHhjdGVzdENvbmZpZ3VyYXRpb24gPSBuZXcgWENUZXN0Q29uZmlndXJhdGlvbih7XG4gICAgICAgICAgICAuLi50aGlzLl9jb25mLFxuICAgICAgICAgICAgLy8gcHJvcGVydGllcyBiZWxvdyBzaG91bGQgbm90IGJlIG92ZXJyaWRlXG4gICAgICAgICAgICB0ZXN0QnVuZGxlVVJMOiBgZmlsZTovLyR7YXBwSW5mby5QYXRofS9QbHVnSW5zLyR7dGFyZ2V0TmFtZX0ueGN0ZXN0YCxcbiAgICAgICAgICAgIHNlc3Npb25JZGVudGlmaWVyLFxuICAgICAgICAgICAgdGFyZ2V0QXBwbGljYXRpb25CdW5kbGVJRDogdGhpcy50YXJnZXRCdW5kbGVJZCxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3dyaXRlQ29uZmlndXJhdGlvblRvRGV2aWNlKHhjdGVzdENvbmZpZ3VyYXRpb24sIHhjdGVzdFBhdGgpO1xuICAgICAgICB0aGlzLl9pbnN0cnVtZW50U2VydmljZSA9IGF3YWl0IHN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgICAgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2UucmVnaXN0ZXJMaWZlY3ljbGVDYWxsYmFjaygnY2xvc2UnLCB0aGlzLnN0b3AuYmluZCh0aGlzKSk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2luc3RydW1lbnRTZXJ2aWNlLmNhbGxDaGFubmVsKFBST0NFU1NfQ09OVFJPTCwgJ3Byb2Nlc3NJZGVudGlmaWVyRm9yQnVuZGxlSWRlbnRpZmllcjonLCB0aGlzLnhjdGVzdEJ1bmRsZUlkKTtcbiAgICAgICAgY29uc3QgYXBwUGF0aCA9IGFwcEluZm8uUGF0aDtcbiAgICAgICAgY29uc3QgeGN0ZXN0Q29uZmlndXJhdGlvblBhdGggPSBhcHBDb250YWluZXIgKyB4Y3Rlc3RQYXRoO1xuICAgICAgICBjb25zdCBhcHBFbnYgPSB7XG4gICAgICAgICAgICBDQV9BU1NFUlRfTUFJTl9USFJFQURfVFJBTlNBQ1RJT05TOiAnMCcsXG4gICAgICAgICAgICBDQV9ERUJVR19UUkFOU0FDVElPTlM6ICcwJyxcbiAgICAgICAgICAgIERZTERfRlJBTUVXT1JLX1BBVEg6IGAke2FwcFBhdGh9L0ZyYW1ld29ya3M6YCxcbiAgICAgICAgICAgIERZTERfTElCUkFSWV9QQVRIOiBgJHthcHBQYXRofS9GcmFtZXdvcmtzYCxcbiAgICAgICAgICAgIE5TVW5idWZmZXJlZElPOiAnWUVTJyxcbiAgICAgICAgICAgIFNRTElURV9FTkFCTEVfVEhSRUFEX0FTU0VSVElPTlM6ICcxJyxcbiAgICAgICAgICAgIFdEQV9QUk9EVUNUX0JVTkRMRV9JREVOVElGSUVSOiAnJyxcbiAgICAgICAgICAgIFhDVGVzdENvbmZpZ3VyYXRpb25GaWxlUGF0aDogeGN0ZXN0Q29uZmlndXJhdGlvblBhdGgsXG4gICAgICAgICAgICBYQ09ERV9EQkdfWFBDX0VYQ0xVU0lPTlM6ICdjb20uYXBwbGUuZHQueGN0ZXN0U3ltYm9saWNhdG9yJyxcbiAgICAgICAgICAgIE1KUEVHX1NFUlZFUl9QT1JUOiAnJyxcbiAgICAgICAgICAgIFVTRV9QT1JUOiAnJyxcbiAgICAgICAgICAgIC8vICVwIG1lYW5zIHBpZFxuICAgICAgICAgICAgTExWTV9QUk9GSUxFX0ZJTEU6IGAke2FwcENvbnRhaW5lcn0vdG1wLyVwLnByb2ZyYXdgLFxuICAgICAgICAgICAgLi4udGhpcy5fZW52XG4gICAgICAgIH07XG4gICAgICAgIGlmIChtYWpvclZlcnNpb24gPj0gTUFKT1JfSU9TX1ZFUlNJT05fMTEpIHtcbiAgICAgICAgICAgIGFwcEVudi5EWUxEX0lOU0VSVF9MSUJSQVJJRVMgPSAnL0RldmVsb3Blci91c3IvbGliL2xpYk1haW5UaHJlYWRDaGVja2VyLmR5bGliJztcbiAgICAgICAgICAgIGFwcEVudi5PU19BQ1RJVklUWV9EVF9NT0RFID0gJ1lFUyc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXBwQXJncyA9IFtcbiAgICAgICAgICAgICctTlNUcmVhdFVua25vd25Bcmd1bWVudHNBc09wZW4nLCAnTk8nLFxuICAgICAgICAgICAgJy1BcHBsZVBlcnNpc3RlbmNlSWdub3JlU3RhdGUnLCAnWUVTJ1xuICAgICAgICBdO1xuICAgICAgICBjb25zdCBhcHBPcHRpb25zID0geyBTdGFydFN1c3BlbmRlZEtleTogZmFsc2UgfTtcbiAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA+PSBNQUpPUl9JT1NfVkVSU0lPTl8xMikge1xuICAgICAgICAgICAgYXBwT3B0aW9ucy5BY3RpdmF0ZVN1c3BlbmRlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbGF1bmNoUmVzdWx0ID0gYXdhaXQgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2UuY2FsbENoYW5uZWwoUFJPQ0VTU19DT05UUk9MLFxuICAgICAgICAgICAgJ2xhdW5jaFN1c3BlbmRlZFByb2Nlc3NXaXRoRGV2aWNlUGF0aDpidW5kbGVJZGVudGlmaWVyOmVudmlyb25tZW50OmFyZ3VtZW50czpvcHRpb25zOicsXG4gICAgICAgICAgICBhcHBQYXRoLCB0aGlzLnhjdGVzdEJ1bmRsZUlkLCBhcHBFbnYsIGFwcEFyZ3MsIGFwcE9wdGlvbnMpO1xuICAgICAgICBjb25zdCBwaWQgPSBsYXVuY2hSZXN1bHQuc2VsZWN0b3I7XG4gICAgICAgIGlmICh0eXBlb2YgcGlkICE9PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoYEZhaWxlZCBvbiBsYXVuY2hpbmcgJHt0aGlzLnhjdGVzdEJ1bmRsZUlkfTogJHtsYXVuY2hSZXN1bHR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmluZm8oYFBpZCBvZiBsYXVuY2hlZCAke3RoaXMueGN0ZXN0QnVuZGxlSWR9OiAke3BpZH1gKTtcbiAgICAgICAgY29uc3QgbXNnID0gbmV3IERUWE1lc3NhZ2VBdXhCdWZmZXIoKTtcbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChwaWQpO1xuICAgICAgICBhd2FpdCB0aGlzLl9pbnN0cnVtZW50U2VydmljZS5jYWxsQ2hhbm5lbChQUk9DRVNTX0NPTlRST0wsICdzdGFydE9ic2VydmluZ1BpZDonLCBtc2cpO1xuICAgICAgICByZXR1cm4gcGlkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7WENUZXN0Q29uZmlndXJhdGlvbn0geGN0ZXN0Q29uZmlndXJhdGlvbiBwbGlzdCBjb250YWluc1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB4Y3Rlc3RQYXRoIHdoZXJlIHhjdGVzdENvbmZpZ3VyYXRpb24gc2hvdWxkIGJlIHBsYWNlIGluIGFwcCBzYW5kYm94LlxuICAgICAqL1xuICAgIGFzeW5jIF93cml0ZUNvbmZpZ3VyYXRpb25Ub0RldmljZSh4Y3Rlc3RDb25maWd1cmF0aW9uLCB4Y3Rlc3RQYXRoKSB7XG4gICAgICAgIGNvbnN0IHhjdGVzdENvbnRlbnQgPSB4Y3Rlc3RDb25maWd1cmF0aW9uLmdldEJ5dGVzKCk7XG4gICAgICAgIGNvbnN0IGhvdXNlQXJyZXN0U2VydmljZSA9IGF3YWl0IHN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgICAgIGxldCB2ZW5kQ29udGFpbmVyO1xuICAgICAgICBsZXQgc3RyZWFtO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmVuZENvbnRhaW5lciA9IGF3YWl0IGhvdXNlQXJyZXN0U2VydmljZS52ZW5kQ29udGFpbmVyKHRoaXMueGN0ZXN0QnVuZGxlSWQpO1xuICAgICAgICAgICAgY29uc3QgbGlzdCA9IGF3YWl0IHZlbmRDb250YWluZXIubGlzdERpcmVjdG9yeShUTVBfRk9MREVSX1BSRUZJWCk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgbGlzdCkge1xuICAgICAgICAgICAgICAgIGlmIChmaWxlLmVuZHNXaXRoKFhDVEVTVF9DT05GSUdVUkFUSU9OX0VYVEVOU0lPTikpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZnVsbFBhdGggPSBgJHtUTVBfRk9MREVSX1BSRUZJWH0vJHtmaWxlfWA7XG4gICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZyhgcmVtb3ZpbmcgJHtmdWxsUGF0aH1gKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdmVuZENvbnRhaW5lci5kZWxldGVEaXJlY3RvcnkoZnVsbFBhdGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0cmVhbSA9IGF3YWl0IHZlbmRDb250YWluZXIuY3JlYXRlV3JpdGVTdHJlYW0oeGN0ZXN0UGF0aCwge30pO1xuICAgICAgICAgICAgYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHN0cmVhbS53cml0ZSh4Y3Rlc3RDb250ZW50LCByZXNvbHZlKTtcbiAgICAgICAgICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgc3RyZWFtPy5lbmQoKTtcbiAgICAgICAgICAgIHZlbmRDb250YWluZXI/LmNsb3NlKCk7XG4gICAgICAgICAgICBob3VzZUFycmVzdFNlcnZpY2UuY2xvc2UoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9zdGFydEluaXRpYWxTZXNzaW9uKG1ham9yVmVyc2lvbikge1xuICAgICAgICB0aGlzLl9pbml0aWFsQ29udHJvbFNlc3Npb24gPSBhd2FpdCBzdGFydFRlc3RtYW5hZ2VyZFNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgICAgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uLnJlZ2lzdGVyTGlmZWN5Y2xlQ2FsbGJhY2soJ2Nsb3NlJywgdGhpcy5zdG9wLmJpbmQodGhpcykpO1xuICAgICAgICBpZiAobWFqb3JWZXJzaW9uIDwgTUFKT1JfSU9TX1ZFUlNJT05fMTEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtc2cgPSBuZXcgRFRYTWVzc2FnZUF1eEJ1ZmZlcigpO1xuICAgICAgICBtc2cuYXBwZW5kT2JqZWN0KFhDT0RFX1ZFUlNJT04pO1xuICAgICAgICBhd2FpdCB0aGlzLl9pbml0aWFsQ29udHJvbFNlc3Npb24uY2FsbENoYW5uZWwoREFFTU9OX0NPTk5FQ1RJT05fSU5URVJGQUNFLFxuICAgICAgICAgICAgJ19JREVfaW5pdGlhdGVDb250cm9sU2Vzc2lvbldpdGhQcm90b2NvbFZlcnNpb246JywgbXNnKTtcbiAgICB9XG5cbiAgICBhc3luYyBfc3RhcnRFeGVjU2Vzc2lvbihzZXNzaW9uSWRlbnRpZmllcikge1xuICAgICAgICB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uID0gYXdhaXQgc3RhcnRUZXN0bWFuYWdlcmRTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgICAgIHRoaXMuX2V4ZWNUZXN0UGxhblNlc3Npb24ucmVnaXN0ZXJMaWZlY3ljbGVDYWxsYmFjaygnY2xvc2UnLCB0aGlzLnN0b3AuYmluZCh0aGlzKSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0RXhlY3V0aW5nID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2V4ZWN1dGluZykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGluZyA9IHRydWU7XG4gICAgICAgICAgICBjb25zdCBtc2cgPSBuZXcgRFRYTWVzc2FnZUF1eEJ1ZmZlcigpO1xuICAgICAgICAgICAgbXNnLmFwcGVuZE9iamVjdChYQ09ERV9WRVJTSU9OKTtcbiAgICAgICAgICAgIHRoaXMuX2V4ZWNUZXN0UGxhblNlc3Npb24uX2NhbGxDaGFubmVsKGZhbHNlLCBNQUdJQ19DSEFOTkVMLCAnX0lERV9zdGFydEV4ZWN1dGluZ1Rlc3RQbGFuV2l0aFByb3RvY29sVmVyc2lvbjonLCBtc2cpO1xuICAgICAgICB9O1xuICAgICAgICBjb25zdCBzaG93TG9nTWVzc2FnZSA9IChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICBpZiAobWVzc2FnZS5hdXhpbGlhcmllcy5qb2luKCcnKS5pbmNsdWRlcygnUmVjZWl2ZWQgdGVzdCBydW5uZXIgcmVhZHkgcmVwbHkgd2l0aCBlcnJvcjogKG51bGwnKSkge1xuICAgICAgICAgICAgICAgIGxvZy5pbmZvKCdUZXN0IHJ1bm5lciByZWFkeScpO1xuICAgICAgICAgICAgICAgIC8vQSBtYWdpYyB0aGluZyBpcyB0aGF0IGlmIG5vdCB1c2luZyBhIGRlbGF5IHRoaXMgd291bGQgZmFpbCBvbiBpUGhvbmU3IGlPUyAxMy42LjFcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHN0YXJ0RXhlY3V0aW5nKCksIDEwMDApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uLnJlZ2lzdGVyU2VsZWN0b3JDYWxsYmFjaygnX1hDVF90ZXN0QnVuZGxlUmVhZHlXaXRoUHJvdG9jb2xWZXJzaW9uOm1pbmltdW1WZXJzaW9uOicsIHN0YXJ0RXhlY3V0aW5nKTtcbiAgICAgICAgdGhpcy5fZXhlY1Rlc3RQbGFuU2Vzc2lvbi5yZWdpc3RlclNlbGVjdG9yQ2FsbGJhY2soJ19YQ1RfbG9nRGVidWdNZXNzYWdlOicsIHNob3dMb2dNZXNzYWdlKTtcbiAgICAgICAgY29uc3QgbXNnID0gbmV3IERUWE1lc3NhZ2VBdXhCdWZmZXIoKTtcbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChuZXcgTlNVVUlEKHNlc3Npb25JZGVudGlmaWVyKSk7XG4gICAgICAgIG1zZy5hcHBlbmRPYmplY3QoYCR7c2Vzc2lvbklkZW50aWZpZXJ9LTc0NkYtMDA2RDcyNjk2NDY0NkM3OWApO1xuICAgICAgICBtc2cuYXBwZW5kT2JqZWN0KFhDT0RFX0JVSUxEX1BBVEgpO1xuICAgICAgICBtc2cuYXBwZW5kT2JqZWN0KFhDT0RFX1ZFUlNJT04pO1xuICAgICAgICBhd2FpdCB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uLmNhbGxDaGFubmVsKERBRU1PTl9DT05ORUNUSU9OX0lOVEVSRkFDRSxcbiAgICAgICAgICAgICdfSURFX2luaXRpYXRlU2Vzc2lvbldpdGhJZGVudGlmaWVyOmZvckNsaWVudDphdFBhdGg6cHJvdG9jb2xWZXJzaW9uOicsIG1zZyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX25vdGlmeVRlc3RQcm9jZXNzSWQocGlkLCBtYWpvclZlcnNpb24pIHtcbiAgICAgICAgY29uc3QgbXNnID0gbmV3IERUWE1lc3NhZ2VBdXhCdWZmZXIoKTtcbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChwaWQpO1xuICAgICAgICBpZiAobWFqb3JWZXJzaW9uID49IE1BSk9SX0lPU19WRVJTSU9OXzEyKSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uLmNhbGxDaGFubmVsKERBRU1PTl9DT05ORUNUSU9OX0lOVEVSRkFDRSxcbiAgICAgICAgICAgICAgICAnX0lERV9hdXRob3JpemVUZXN0U2Vzc2lvbldpdGhQcm9jZXNzSUQ6JywgbXNnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWFqb3JWZXJzaW9uIDw9IE1BSk9SX0lPU19WRVJTSU9OXzkpIHtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9pbml0aWFsQ29udHJvbFNlc3Npb24uY2FsbENoYW5uZWwoREFFTU9OX0NPTk5FQ1RJT05fSU5URVJGQUNFLFxuICAgICAgICAgICAgICAgICdfSURFX2luaXRpYXRlQ29udHJvbFNlc3Npb25Gb3JUZXN0UHJvY2Vzc0lEOicsIG1zZyk7XG4gICAgICAgIH1cbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChYQ09ERV9WRVJTSU9OKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2luaXRpYWxDb250cm9sU2Vzc2lvbi5jYWxsQ2hhbm5lbChEQUVNT05fQ09OTkVDVElPTl9JTlRFUkZBQ0UsXG4gICAgICAgICAgICAnX0lERV9pbml0aWF0ZUNvbnRyb2xTZXNzaW9uRm9yVGVzdFByb2Nlc3NJRDpwcm90b2NvbFZlcnNpb246JywgbXNnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydCB4Y3Rlc3QgcHJvY2Vzcy4gSWYgdGhpcyBtZXRob2QgaGFzIGJlZW4gY2FsbGVkIGJlZm9yZSBhbmQgdGhlIGBzdG9wKClgIG1ldGhvZCBoYXMgbm90IGJlZW4gY2FsbGVkLFxuICAgICAqIGNhbGxpbmcgdGhpcyBhZ2FpbiB3b3VsZCByZXR1cm4gZGlyZWN0bHkuXG4gICAgICogQHRocm93cyBJZiB4Y3Rlc3QgYnVuZGxlIGlkIGludmFsaWQgb3Igbm90IGluc3RhbGxlZC5cbiAgICAgKi9cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgaWYgKHRoaXMucnVubmluZykge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0TWVzc2FnZSA9IHRoaXMudGFyZ2V0QnVuZGxlSWQgPyBgKHRhcmdldGluZyAke3RoaXMudGFyZ2V0QnVuZGxlSWR9KWAgOiAnJztcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgWGN0ZXN0IGZvciAke3RoaXMueGN0ZXN0QnVuZGxlSWR9JHt0YXJnZXRNZXNzYWdlfSBvbiBkZXZpY2UgJHt0aGlzLnVkaWR9IGlzIGFscmVhZHkgcnVubmluZyFgO1xuICAgICAgICAgICAgbG9nLmluZm8oYCR7bWVzc2FnZX0gRG9pbmcgbm90aGluZyBoZXJlYCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHByb2R1Y3RWZXJzaW9uID0gYXdhaXQgZ2V0T1NWZXJzaW9uKHRoaXMudWRpZCk7XG4gICAgICAgICAgICBjb25zdCBtYWpvclZlcnNpb24gPSBwYXJzZUludChwcm9kdWN0VmVyc2lvbi5zcGxpdCgnLicpWzBdLCAxMCk7XG4gICAgICAgICAgICBjb25zdCBzZXNzaW9uSWRlbnRpZmllciA9IHV0aWwudXVpZFY0KCk7XG4gICAgICAgICAgICAvL2ZpcnN0IGNvbm5lY3Rpb25cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3N0YXJ0SW5pdGlhbFNlc3Npb24obWFqb3JWZXJzaW9uKTtcblxuICAgICAgICAgICAgLy9zZWNvbmQgY29ubmVjdGlvblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fc3RhcnRFeGVjU2Vzc2lvbihzZXNzaW9uSWRlbnRpZmllcik7XG5cbiAgICAgICAgICAgIGNvbnN0IHBpZCA9IGF3YWl0IHRoaXMuX2xhdW5jaEFwcFJ1bm5lcihtYWpvclZlcnNpb24sIHNlc3Npb25JZGVudGlmaWVyKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeVRlc3RQcm9jZXNzSWQocGlkLCBtYWpvclZlcnNpb24pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wIHhjdGVzdCBwcm9jZXNzLlxuICAgICAqL1xuICAgIHN0b3AoKSB7XG4gICAgICAgIGlmICghdGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICAvLyBub3Qgc3RhcnRlZCBvciBhbHJlYWR5IGNhbGxlZCBgc3RvcCgpYFxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9pbnN0cnVtZW50U2VydmljZT8uY2xvc2UoKTtcbiAgICAgICAgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2U/LmRpc3Bvc2UoKTtcbiAgICAgICAgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2UgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuX2V4ZWNUZXN0UGxhblNlc3Npb24/LmNsb3NlKCk7XG4gICAgICAgIHRoaXMuX2V4ZWNUZXN0UGxhblNlc3Npb24/LmRpc3Bvc2UoKTtcbiAgICAgICAgdGhpcy5fZXhlY1Rlc3RQbGFuU2Vzc2lvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uPy5jbG9zZSgpO1xuICAgICAgICB0aGlzLl9pbml0aWFsQ29udHJvbFNlc3Npb24/LmRpc3Bvc2UoKTtcbiAgICAgICAgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLl9leGVjdXRpbmcgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgdGFyZ2V0TWVzc2FnZSA9IHRoaXMudGFyZ2V0QnVuZGxlSWQgPyBgKHRhcmdldGluZyAke3RoaXMudGFyZ2V0QnVuZGxlSWR9KWAgOiAnJztcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBYY3Rlc3QgZm9yICR7dGhpcy54Y3Rlc3RCdW5kbGVJZH0ke3RhcmdldE1lc3NhZ2V9IG9uIGRldmljZSAke3RoaXMudWRpZH0gaGFzIHN0b3BwZWQhYDtcbiAgICAgICAgbG9nLmRlYnVnKG1lc3NhZ2UpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgWGN0ZXN0IH07XG5leHBvcnQgZGVmYXVsdCBYY3Rlc3Q7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQUEsU0FBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsV0FBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsUUFBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsUUFBQSxHQUFBSCxPQUFBO0FBQ0EsSUFBQUksYUFBQSxHQUFBSixPQUFBO0FBQ0EsSUFBQUssUUFBQSxHQUFBTCxPQUFBO0FBQ0EsSUFBQU0sVUFBQSxHQUFBTixPQUFBO0FBQ0EsSUFBQU8sT0FBQSxHQUFBQyxzQkFBQSxDQUFBUixPQUFBO0FBQ0EsSUFBQVMsU0FBQSxHQUFBRCxzQkFBQSxDQUFBUixPQUFBO0FBRUEsTUFBTTtFQUFF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